// src/tests/test-RAGStep.ts
import { mastra } from "../mastra/index";

async function main() {
  try {
    console.log("Testing RAGStep...");

    // Sample input data for the RAG step
    const inputData = {
      fileUrl:
        "hhttps://lovable-mule-900.convex.cloud/api/storage/1d031aaa-8066-45df-93e0-e3ec2e8a57ce",
      conversationText:
        "[00:12] Stewie: Hope I'm not bothering you.\n[00:13] Brian: Nope. Just doing some stretching, maybe a few poses.\n[00:18] Stewie: You'll tell me if I'm bothering you, right?\n[00:20] Brian: Uh-huh.\n[00:21] Stewie: I know what you're thinking. Stewie is so late to the yoga party.\n[00:25] Stewie: I'm not even any good.\n[00:27] Stewie: Right?\n[00:28] Stewie: I mean, I'm okay. You know, I'm not the worst in the class.\n[00:31] Stewie: I've even been singled out a few times.\n[00:33] Stewie: Probably because it's mostly pregnant women in the group.\n[00:36] Stewie: Still, Brody must see something.\n[00:38] Stewie: Although I certainly don't.\n[00:39] Stewie: But then again, I'm not the instructor, am I?\n[00:42] Stewie: Oh, yuck! What happened to my ear?\n[00:43] Brian: We pierced it.\n[00:45] Stewie: Oh, yeah.\n[00:47] Stewie: A lot of crazy went on last night.\n[00:49] Brian: Well, we were both drunk.\n[00:51] Stewie: Oh, of course, of course.\n[00:52] Stewie: Oh, yes, that's right. We were four pillows to the breeze, my friend.\n[00:55] Stewie: I don't know what the phrase is. But what are you what are you reading?\n[00:58] Brian: David Copperfield.\n[01:00] Stewie: Looks old.\n[01:01] Brian: It's a first edition. That's why I keep it in my safety deposit box.\n[01:04] Brian: It's by Charles Dickens.\n[01:05] Stewie: Ha, giggity.\n[01:11] Brian: What are you doing?\n[01:11] Stewie: I was hungry.\n[01:13] Stewie: You want one?\n[01:14] Brian: You've had energy bars this whole time, you idiot!\n[01:17] Stewie: Not energy bars, Jenny Craig anytime bars, and you just bitched yourself out of a bite.\n[01:22] Brian: All right, I'm sorry.\n[01:23] Brian: All right, can I have one, please?\n[01:25] Stewie: All right.\n[01:26] Brian: Can you give me a caramel one?\n[01:28] Stewie: No.\n[01:29] Stewie: You can have um um you can have um you can have strawberry yogurt.\n[01:37] Brian: I don't like strawberry yogurt.\n[01:38] Stewie: Oh, picky for someone who eats the same food out of a plastic bowl on the floor every night.\n[01:42] Brian: Okay, I get it.\n[01:43] Stewie: A bowl that starts in the kitchen at the beginning of a meal and ends up in the living room.\n[01:47] Brian: Shut up!\n[01:48] Stewie: And then forgets four seconds later that he ate it.\n[01:50] Brian: Shut up!\n[01:51] Stewie: Ooh, harsh tone. You just got bumped down to coconut mint.\n[01:53] Brian: Ha.\n[02:02] Stewie: Hey, Bry.\n[02:04] Brian: Yeah.\n[02:05] Stewie: How come you have a gun?\n[02:08] Brian: I don't know.\n[02:09] Stewie: What do you mean you don't know? You're all what about all that liberal crap you're always spewing about stricter gun regulations?\n[02:15] Stewie: You even cried after Columbine.\n[02:17] Brian: Because that was a national tragedy.\n[02:18] Stewie: Uh, it's kind of a regional tragedy.\n[02:20] Brian: Whatever.\n[02:21] Stewie: It's just weird, you know? I mean, you're the last person anybody would expect to have a gun.\n[02:25] Brian: Well, that's why I keep it here where it's safe.\n[02:27] Stewie: That doesn't make any sense. Why have it if you're not going to use it?\n[02:31] Stewie: Is it like a sexual thing?\n[02:33] Brian: No.\n[02:33] Stewie: Oh, that's a relief.\n[02:35] Stewie: I hate the idea of you getting your thrills pressing a gun up against your crotch.\n[02:39] Stewie: Uh, just picturing it gives me the willies.\n[02:41] Brian: You know, I I really don't want to talk about this with you, Stewie.\n[02:43] Stewie: Okay. Okay, I respect that.\n[02:45] Brian: Thank you.\n[02:47] Stewie: Are you sure it's not a sexual thing?\n[02:50] Brian: I'm sure.\n[02:51] Stewie: Oh, good, cuz that'd be strange if you had fantasies about pressing a gun up against your crotch and feeling your heartbeat through your balls.\n[02:58] Stewie: Please tell me why you have it.\n[03:00] Brian: I said I don't want to talk about it.\n[03:02] Stewie: But I want to know. Just tell me. Come on.\n[03:04] Brian: No.\n[03:04] Stewie: Come on, please.\n[03:09] Brian: I keep it in case I ever want to commit suicide, okay?\n[03:14] Stewie: Wow.\n[03:16] Stewie: Oh.\n[03:18] Stewie: Oh my god. You're You're serious.\n[03:21] Stewie: But why, Brian?\n[03:22] Brian: You wouldn't understand. You're just a kid.\n[03:24] Stewie: Well, I could try.\n[03:26] Brian: I don't know. Sometimes it's all too much.\n[03:30] Stewie: What is?\n[03:31] Brian: Life, everything.\n[03:33] Brian: Just having the gun here, knowing there's a way out, it It helps.\n[03:38] Stewie: Yes, but a gun, it's so messy.\n[03:41] Stewie: What about pills?\n[03:42] Stewie: Even hanging yourself is better. At least then you might grow an inch or two while you're hanging there.\n[03:47] Stewie: Of course, when they find you, you might have those Illeana Douglas eyes.\n[03:50] Brian: Hm.\n[03:51] Stewie: So, um, why the gun?\n[03:54] Brian: It just seemed the quickest way, I guess.\n[03:58] Stewie: Oh, I suppose.\n[04:00] Stewie: I I don't quite understand why you're so unhappy.\n[04:04] Brian: Yesterday, when you said I don't live with purpose.\n[04:09] Brian: You were right. I don't. What purpose does my life have?\n[04:14] Stewie: I don't like when you talk like this.\n[04:15] Brian: Oh, it's true, Stewie.\n[04:17] Brian: Dogs are supposed to be able to instinctively live with purpose, not even have to think about it, just born like that.\n[04:22] Brian: But I wasn't.\n[04:25] Brian: You know, I've tried to find meaning in my life and I just I just can't.\n[04:32] Stewie: And that bottle of Scotch?\n[04:34] Brian: I was saving it for my last drink.\n[04:37] Stewie: Whoa, heavy.\n[04:38] Brian: And you know, I'm not talking about purpose in the shallow Rick Warren over the counter self-help variety, because that's just delusion. That's not real.\n[04:45] Brian: I mean, is there ever a time when we're truly in the present moment and not looking toward the past or the future? I mean, right there in the moment.\n[04:54] Stewie: I get that way when I watch Handy Manny.\n[04:58] Stewie: So, is that why we came here? Were you going to end it?\n[05:03] Brian: No, I was just putting money in my Christmas club.\n[05:05] Stewie: God, I have to get one of those.\n[05:06] Stewie: You know, last year, I only had $30 saved when the holidays came around. I was so embarrassed.\n[05:11] Stewie: I think I gave Meg tape.\n[05:14] Brian: You're the only person I've ever told this to.\n[05:19] Brian: Aren't you going to say anything?\n[05:21] Stewie: I don't know what to say. Wanting to kill yourself.\n[05:26] Stewie: Well, I think that's pretty selfish of you.\n[05:27] Brian: How is that selfish?\n[05:29] Stewie: What would I do if you weren't here?\n[05:31] Stewie: Huh?\n[05:32] Stewie: You're the only one who makes my life bearable.\n[05:34] Brian: Thought you said I was the best of a bad situation.\n[05:38] Stewie: I was just trying to hurt you because you hurt me.\n[05:40] Stewie: But the truth is,\n[05:42] Stewie: you're my only friend, Brian. If I didn't have you, I'd be lost.\n[05:45] Brian: You'd be okay.\n[05:46] Stewie: No, I wouldn't.\n[05:47] Stewie: I don't really care for anybody else, just you.\n[05:50] Stewie: You're the only one I like.\n[05:52] Brian: Well, thanks.\n[05:55] Stewie: I like you a lot.\n[05:58] Stewie: I guess you could say I really like you.\n[06:02] Stewie: I would even dare to go a little further, perhaps. I care a great deal about you.\n[06:09] Stewie: A very great deal.\n[06:11] Stewie: Maybe even deeper than that.\n[06:16] Stewie: I I love you.\n[06:20] Stewie: I mean, you know, not in like a hey, let's, you know, let's have an underpants party or whatever grown-ups do when they're in love, but I mean, I mean, I love you as one loves another person whom one simply cannot do without.\n[06:34] Brian: I I love you, too, Stewie.\n[06:38] Stewie: You give my life purpose.\n[06:40] Stewie: And maybe maybe that's enough.\n[06:43] Stewie: Because that's just about the greatest gift one friend can give another.\n[06:49] Brian: Thank you.\n[06:51] Stewie: Hey.\n[06:52] Brian: What?\n[06:53] Stewie: Will you read to me?\n[06:54] Brian: Sure.\n[06:55] Stewie: Wait, wait, wait. I want to get all snuggled in.\n[06:58] Stewie: Okay, go.\n[07:01] Brian: Chapter one. I am born. Whether I shall turn out to be the hero of my own life, or whether that station shall be held by anybody else, these pages must show. To begin my life with the beginning of my life, I record that I was born on a Friday, at 12 o'clock at night.",
      analysis:
        "Here are the core, axiom-like claims each speaker puts forward in this exchange.\n\nStewie’s core claims\n- S1: Brian is Stewie’s life purpose and his only meaningful connection. He repeatedly says Brian “gives my life purpose,” that Brian is his “only friend,” and that without Brian Stewie would be lost.\n- S2: Stewie loves Brian and cares deeply about him; he also says he “really likes” Brian and that Brian is the only one he cares for or likes.\n- S3: The relationship with Brian is a source of closeness and daily meaning (Stewie wants to be read to, snuggled, and shares intimate, supportive moments with Brian).\n- S4: The bond with Brian is so central that Brian’s well-being and existence are treated as a fundamental necessity for Stewie’s own sense of self.\n\nBrian’s core claims\n- B1: I lack a clear, intrinsic purpose in life; “What purpose does my life have?” and “I don’t live with purpose.”\n- B2: The idea that humans (even a dog-like being) should be born with or instinctively possess a sense of purpose is at odds with his experience; he suggests dogs might have purpose instinctively, but he does not feel that about himself.\n- B3: Self-help prescriptions about “living with purpose” or grand life-meaning are not real or sufficient for him; he critiques shallow self-help (e.g., Rick Warren) as delusional.\n- B4: He is preoccupied with the idea of a “present moment” and questions whether anyone can truly live only in the present, not looking to past or future.\n- B5: Suicide is presented as a real, contemplated option for him; he keeps a gun as a potential quick exit and explicitly says he might use it.\n- B6: He has tried to find meaning and purpose but cannot, implying a deep existential struggle.\n- B7: Despite the struggle, he does acknowledge, in an important moment, that he does care for and even loves Stewie, and that their relationship is meaningful to him (reciprocal affection is hinted through his responses).",
      reasoning:
        "Short answer: Brian’s line of thinking is, by traditional logic standards, the more coherent and sound overall. Stewie’s statements are emotionally rich and internally consistent as personal claims, but they rely more on a single relational premise (Brian provides Stewie’s life meaning) without independent premises to support that conclusion. Brian presents a more explicit, self-consistent, and skeptical account of meaning in life, which makes his arguments comparatively stronger on logical grounds.\n\nReasoning, organized by the four criteria you gave\n\n1) Logical consistency of each speaker’s arguments\n- Stewie (S1–S4)\n  - Consistency: S1–S4 are mutually compatible. They all describe Stewie’s life as meaningfully anchored to Brian and the relationship as the central tie to selfhood and daily significance.\n  - Potential issue: The core claim (that Brian is Stewie’s life purpose and the only meaningful connection) is assertive but not defended by independent premises. If treated as an argument, it relies on a single relational premise rather than a chain of premises deriving the conclusion.\n  - Possible fallacies: circularity (the idea that Brian is the meaning of Stewie’s life because Stewie’s life is meaningful only insofar as Brian is in it) and an appeal to emotion. Without independent supporting premises, the claim can feel like a restatement of the conclusion in different words.\n- Brian (B1–B7)\n  - Consistency: Very high. Brian consistently presents a coherent worldview: no intrinsic life purpose detected, skepticism about grand life-meaning formulas, interest in present-miveness as a philosophical question, and an honest (though troubling) admission of suicidal ideation as a possible option given his existential state. He then acknowledges care for Stewie, which is consistent with his emotional state and with S4 in Stewie’s terms (even if not formally argued).\n  - Potential issue: the leap from “I lack purpose” to statements about suicide are not arguments so much as disclosures of existential state. Not a logical inference chain, but these disclosures do not generate internal contradictions.\n  - Possible fallacies: none obvious as formal fallacies; at times the discussion about suicide and guns may appear as a dramatic jump in reason from existential angst to specific means, but again these are personal disclosures rather than deduced conclusions.\n\nBottom line on consistency: Both sets are internally consistent, but Brian’s are more systematically organized as (i) a skeptical stance about meaning, (ii) an openness to present-mocused reflection, and (iii) a clear acknowledgment of the relationship’s value. Stewie’s claims, while coherent, lean more on a single premise about meaning derived from the relationship rather than a structured argumentative chain.\n\n2) Validity of reasoning patterns\n- Stewie: The claims read like declarative statements about what is meaningful to him. There isn’t an explicit inferential form shown (e.g., A -> B -> C). If treated as arguments, they are weak in the sense that there is no independently established premise establishing that Brian must be the life purpose for Stewie; the “conclusion” is largely a restatement of a premise about his feelings.\n- Brian: The reasoning is more about a consistent worldview than about a single inferential chaîne. There is not a formal syllogism presented, but the pattern is a coherent sequence of existential attitudes (no intrinsic purpose, critique of easy self-help, contemplation of present moment, recognition of distress) that hang together logically as a worldview. The move from “lack of purpose” to “present moment” and to “distress” is not strictly deductive, but it reflects a plausible, non-contradictory pattern of reasoning.\nConclusion on validity: Neither speaker uses formal deductive validity, but Brian’s pattern is more systematically coherent and less dependently tied to a single relational premise than Stewie’s.\n\n3) Soundness of conclusions based on premises\n- Stewie: The conclusions (Brian is life purpose, Brian is the only meaningful connection) are not supported by independently justifiable premises in the dialogue. Within the story, they are true as asserted by Stewie, but from a traditional logic standpoint they are not demonstrably sound because there isn’t an external, verifiable chain of premises and logical derivation supplied.\n- Brian: The conclusions (no intrinsic life purpose; modern skepticism about grand life-meaning prescriptions; present-moment inquiry; distress about meaning; suicide as a real option given his state; still capable of care and love for Stewie) are supported by the premises he openly articulates (B1–B6). While “soundness” in real life would require truth of the premises, within the fictional context those premises are coherent and support the resulting conclusions. The inclusion of B7 (care/love for Stewie) helps avoid a purely nihilistic position and makes the set more credible as a lived worldview.\nConclusion on soundness: Brian’s set is more sound in the logical sense, because its premises form a coherent, self-consistent stance and its conclusions follow in a manner that, while non-deductive, is not in tension with the premises. Stewie’s conclusions are not well-supported by independent premises and rely more on a single central assertion about meaning.\n\n4) Identification of any logical fallacies\n- Stewie:\n  - Potential fallacies or weak moves: circularity (defining meaning in terms of the relationship that creates the meaning), sentimental appeal (emotional weighting over independent justification), and possible equivocation on “life purpose” (to call Brian the life purpose is to make the meaningfulness depend on one person without broader justification).\n- Brian:\n  - Not many clear formal fallacies are present. His self-critical stance toward “living with purpose” and his critique of easy self-help is a reasonable skeptical position. The talk about suicide, while alarming, is a disclosure of mental state rather than a faulty argument. If one tries to infer a normative conclusion (e.g., “therefore I should end my life now”) from his premises, that would be a fallacy (non sequitur), but the dialogue does not present that explicit inference.\n\nOverall assessment\n- Which speaker is more logically correct? Brian.\n  - Why: Brian offers a more consistent, self-contained, and defensible epistemic stance about meaning and existence. He treats life purpose as a question to be analyzed rather than a given. His conclusions follow (or at least align) with his stated premises in a non-circular way and he does not rely on a single relational premise to define his entire sense of self.\n  - Stewie, while emotionally coherent and internally consistent, rests on a strong, non-independent premise about the source of his life meaning (Brian as life purpose). This premise is not defended by an independent chain of reasoning, and thus, from a formal logic perspective, less sound as an argument.\n\nCaveats\n- Both speakers are expressing personal, introspective, and emotionally charged positions rather than formal arguments. In a strict logical sense, neither is presenting a fully articulated deductive argument with explicit premises and a conclusion; they are communicating beliefs about meaning, purpose, and love.\n- The topic touches mental health (notably Brian’s suicide risk). If this were a real-world assessment, one should treat these disclosures with care and encourage appropriate support.\n\nIf you’d like, I can formalize Brian’s and Stewie’s positions into explicit, labeled Premise-Conclusion constructions (P1, P2, …; C) to show the exact inferential structure and where any potential gaps or fallacies lie.",
      resourceId: "k57d23fmq5j4fm44zsf7acdfvh7ztjh1",
    };

    // Get the workflow that contains the RAG step
    const workflow = mastra.getWorkflow("conversationWorkflow");
    const run = await workflow.createRunAsync();

    console.log(
      "Starting workflow with input:",
      JSON.stringify(inputData, null, 2),
    );

    const res = await run.start({
      inputData: inputData,
    });

    console.log("Workflow result:", JSON.stringify(res, null, 2));

    const ragStep = res.steps["RAG-step"];
    if (ragStep?.status === "success") {
      console.log("RAG step succeeded with output:", ragStep.output);
    } else if (ragStep?.status === "failed") {
      console.error("RAG step failed with error:", ragStep.error);
    } else {
      console.log("RAG step status:", ragStep?.status);
    }

    if (res.status === "success") {
      console.log("Overall workflow succeeded with result:", res.result);
    } else if (res.status === "failed") {
      console.error("Overall workflow failed");
    }
  } catch (error) {
    console.error("Error running RAG step test:", error);
  }
}

main().catch(console.error);
